<div class="support-info-card">
    <div class="support-header">
        <h2 class="support-title">{{ translate('supportInformation.title') }}</h2>
        <div class="debug-controls" *ngIf="false" style="margin-top: 0.5rem;">
            <button type="button" class="btn btn-outline-light btn-sm me-2" (click)="manualSaveFormData()"
                [disabled]="!hasFormData()">
                {{ translate('supportInformation.manualSave') }}
            </button>
            <button type="button" class="btn btn-outline-light btn-sm"
                (click)="debugLog('Debug Info:', getFormDebugInfo())">
                {{ translate('supportInformation.debugInfo') }}
            </button>
        </div>
    </div>

    <div class="text-center py-4" *ngIf="isLoadingTicketData">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">{{ translate('common.loading') }}</span>
        </div>
        <p class="text-muted mt-2">{{ translate('supportInformation.loading') }}</p>
        <small class="text-muted">{{ translate('supportInformation.systemSaveMsg') }}</small>
    </div>

    <div id="supporterFormSection" class="supporter-form-section" *ngIf="canShowSupporterForm()">

        <div class="alert alert-success d-flex align-items-start"
            *ngIf="getFormPersistenceStatus().hasPersistedData && !isJustSaved && getFormPersistenceStatus().isValidForCurrentTicket"
            role="alert">
            <i class="bi bi-cloud-check me-2 mt-1"></i>
            <div>
                <strong>üîí {{ translate('supportInformation.autoSaved') }}</strong>
                <div class="mt-1">
                    <small class="text-muted">
                        {{ translate('supportInformation.savedAt') }}: {{ getFormPersistenceStatus().lastSaved | date:'dd/MM/yyyy HH:mm:ss' }}
                        <span *ngIf="getFormPersistenceStatus().dataAge < 60">
                            ({{ getFormPersistenceStatus().dataAge }} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß)
                        </span>
                        <span *ngIf="getFormPersistenceStatus().dataAge >= 60">
                            ({{ (getFormPersistenceStatus().dataAge / 60) | number:'1.0-0' }} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß)
                        </span>
                    </small>
                </div>
                <div class="mt-1">
                    <small class="text-success">
                        <i class="bi bi-shield-check me-1"></i>
                        {{ translate('supportInformation.safeRefresh') }}
                    </small>
                </div>
            </div>
        </div>

        <div class="alert alert-danger d-flex align-items-center" *ngIf="supporterFormState.error" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>{{ supporterFormState.error }}</div>
        </div>

        <div class="alert alert-success d-flex align-items-center" *ngIf="supporterFormState.successMessage"
            role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            <div>{{ supporterFormState.successMessage }}</div>
        </div>

        <div class="alert alert-info d-flex align-items-center" *ngIf="!isFormReady() && !isLoadingTicketData">
            <i class="bi bi-info-circle me-2"></i>
            <div>
                <strong>{{ translate('supportInformation.formStatus') }}:</strong> {{ getFormStatusMessage() }}
                <div class="mt-1" *ngIf="!ticketData?.ticket">
                    <small class="text-muted">{{ translate('supportInformation.waitingForTicket') }}</small>
                </div>
            </div>
        </div>

        <form class="supporter-form" [formGroup]="supporterForm" [class.form-disabled]="!isFormReady()"
            [class.form-saving]="supporterFormState.isSaving">

            <div class="form-section">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label class="required">{{ translate('supportInformation.actions') }}</label>

                            <div *ngIf="isLoadingActions" class="form-control d-flex align-items-center">
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span class="text-muted">{{ translate('supportInformation.loadingList') }}</span>
                            </div>

                            <div *ngIf="actionError && !isLoadingActions" class="alert alert-warning p-2 mb-2"
                                role="alert">
                                <small class="d-flex align-items-center">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    <span>{{ actionError }}</span>
                                    <button type="button" class="btn btn-outline-warning btn-sm ms-auto"
                                        (click)="refreshActionDropdown()" [disabled]="!isFormReady()"
                                        title="‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Action ‡πÉ‡∏´‡∏°‡πà">
                                        <i class="bi bi-arrow-clockwise me-1"></i>
                                        {{ translate('common.reload') }}
                                    </button>
                                </small>
                            </div>

                            <select id="action" class="form-select" formControlName="action"
                                [class.is-invalid]="supporterForm.get('action')?.invalid && supporterForm.get('action')?.touched"
                                [disabled]="!isFormReady() || isLoadingActions || supporterFormState.isSaving || (!isAdmin && !isSupporter)"
                                *ngIf="!isLoadingActions">
                                <option value="">{{ translate('supportInformation.chooseAction') }}</option>
                                <option *ngFor="let option of actionDropdownOptions; trackBy: trackByActionOption"
                                    [value]="option.statusId" [disabled]="option.disabled">
                                    {{ option.label }}
                                </option>
                            </select>

                            <small class="form-text text-muted" *ngIf="supporterForm.get('action')?.value">
                                {{ translate('supportInformation.actionHint') }}
                            </small>
                        </div>
                    </div>

                    <div class="col-md-3" *ngIf="canUserChangePriority">
                        <div class="form-group">
                            <label class="required">{{ translate('supportInformation.priority') }}</label>

                            <div *ngIf="isLoadingPriorities" class="form-control d-flex align-items-center">
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                <span class="text-muted">{{ translate('supportInformation.loadingList') }}</span>
                            </div>

                            <div *ngIf="priorityError && !isLoadingPriorities" class="form-control readonly-box">
                                {{ getPriorityName(supporterForm.get('priority')?.value) || '-' }}
                            </div>

                            <select id="priority" class="form-select" formControlName="priority"
                                [disabled]="!isFormReady() || isLoadingPriorities || supporterFormState.isSaving || !isAdmin"
                                *ngIf="!isLoadingPriorities && !priorityError">
                                <option [value]="null">{{ translate('supportInformation.choosePriority') }}</option>
                                <option *ngFor="let option of priorityDropdownOptions; trackBy: trackByPriorityOption"
                                    [value]="option.id">
                                    {{ option.name }}
                                </option>
                            </select>

                            <small class="form-text text-muted">
                                {{ translate('supportInformation.priorityHint') }}
                            </small>
                        </div>
                    </div>

                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="required">{{ translate('supportInformation.closeEstimate') }}:</label>
                    <input type="datetime-local" id="close_estimate" class="form-control"
                        formControlName="close_estimate" [class.is-invalid]="hasFieldError('close_estimate')"
                        [disabled]="!isFormReady() || supporterFormState.isSaving || isAdmin">

                    <div *ngIf="supporterForm.get('close_estimate')?.dirty && hasFieldError('close_estimate')"
                        class="invalid-feedback">
                        {{ getFieldError('close_estimate') }}
                    </div>

                    <small class="form-text text-muted"
                        *ngIf="!supporterForm.get('close_estimate')?.dirty || !hasFieldError('close_estimate')">
                        {{ translate('supportInformation.closeEstimateHint') }}
                    </small>
                </div>

                <div class="divider"></div>

                <div class="form-group">
                    <label>{{ translate('supportInformation.estimateTime') }}:</label>
                    <input type="text" class="form-control form-control-as-text" 
                        [value]="(supporterForm.get('estimate_time')?.value || 0) + ' ' + translate('supportInformation.hoursUnit')"
                        [class.is-invalid]="hasFieldError('estimate_time')" 
                        readonly />
                    <div *ngIf="hasFieldError('estimate_time')" class="invalid-feedback">
                        {{ getFieldError('estimate_time') }}
                    </div>
                </div>

                <div class="divider"></div>

                <div class="form-group">
                    <label class="required">{{ translate('supportInformation.dueDate') }}:</label>
                    <input type="datetime-local" id="due_date" class="form-control input-duedate"
                        formControlName="due_date" [class.is-invalid]="hasFieldError('due_date')"
                        [disabled]="!isSupporter || supporterFormState.isSaving || !isFormReady() || !isResolvedActionSelected" />
                        <div *ngIf="supporterForm.get('due_date')?.dirty && hasFieldError('due_date')"
                        class="invalid-feedback">
                        {{ getFieldError('due_date') }}
                    </div>

                    <small class="form-text text-muted"
                        *ngIf="!supporterForm.get('due_date')?.dirty || !hasFieldError('due_date')">
                        {{ translate('supportInformation.dueDateHint') }}
                    </small>
                </div>

                <div class="divider"></div>

                <div class="form-group">
                    <label>{{ translate('supportInformation.leadTime') }}:</label>
                    <input type="text" class="form-control form-control-as-text" 
                        [value]="(supporterForm.get('lead_time')?.value || 0) + ' ' + translate('supportInformation.hoursUnit')"
                        [class.is-invalid]="hasFieldError('lead_time')" 
                        readonly />
                    <div *ngIf="hasFieldError('lead_time')" class="invalid-feedback">
                        {{ getFieldError('lead_time') }}
                    </div>
                </div>
            </div>

            <div class="search-section">
                <div class="form-group width-364" *ngIf="canAssignTicket()">
                    <label class="required">{{ translate('supportInformation.assign') }}</label>

                    <div *ngIf="isLoadingAssignees" class="form-control d-flex align-items-center">
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        <span class="text-muted">{{ translate('supportInformation.loadingList') }}</span>
                    </div>

                    <div *ngIf="assigneeError && !isLoadingAssignees" class="alert alert-warning p-2 mb-2" role="alert">
                        <small class="d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            <span>{{ assigneeError }}</span>
                            <button type="button" class="btn btn-outline-warning btn-sm ms-auto"
                                (click)="refreshAssigneeList()" [disabled]="!isFormReady()"
                                title="‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà">
                                <i class="bi bi-arrow-clockwise me-1"></i>
                                {{ translate('common.tryAgain') }}
                            </button>
                        </small>
                    </div>

                    <select class="form-control select-field" [(ngModel)]="selectedAssigneeId"
                        [ngModelOptions]="{standalone: true}" (change)="onAssigneeChanged()"
                        [disabled]="!isFormReady() || !isAssigneeDropdownReady() || supporterFormState.isSaving || !isAdmin"
                        *ngIf="!isLoadingAssignees && !assigneeError">
                        <option [ngValue]="null" [disabled]="getSelectedAssigneeName()">
                            {{ getSelectedAssigneeName() || translate('supportInformation.chooseAssignee') }}
                        </option>
                        <option *ngFor="let user of assigneeList; trackBy: trackByUser" [ngValue]="user.id"
                            [selected]="user.id === selectedAssigneeId">
                            {{ getUserDisplayName(user) }}
                        </option>
                    </select>
                </div>

                <div class="form-group width-363">
                    <label>{{ translate('supportInformation.relatedTickets') }}</label>
                    <input type="text" id="related_ticket_id" class="form-control" formControlName="related_ticket_id"
                        [class.is-invalid]="hasFieldError('related_ticket_id')"
                        [attr.placeholder]="translate('supportInformation.relatedTicketsPlaceholder')"
                        [disabled]="!isFormReady() || supporterFormState.isSaving || !isAdmin">
                    <div *ngIf="hasFieldError('related_ticket_id')" class="invalid-feedback">
                        {{ getFieldError('related_ticket_id') }}
                    </div>
                    <small class="form-text text-muted" *ngIf="!hasFieldError('related_ticket_id')">
                        {{ translate('supportInformation.relatedTicketsHint') }}
                    </small>
                </div>
            </div>

            <div class="form-section">
                <div class="form-group width-364">
                    <label>{{ translate('supportInformation.changeRequest') }}:</label>
                    <div class="input-field days-display" [class.disabled-visual]="!isAdmin">
                        <i class="bi bi-calendar-days me-2 text-muted"></i>
                        <span class="fw-bold">{{ ticketData?.ticket?.change_request || '0' }}</span>
                        <span class="unit-text">{{ translate('supportInformation.days') }}</span>
                    </div>
                    <small class="form-text text-muted">
                        {{ translate('supportInformation.changeRequestHint') }}
                    </small>
                </div>
            </div>

            <div class="form-section">
                <div class="form-group">
                    <label class="required">{{ translate('supportInformation.issueResolution') }}</label>

                    <div class="rich-text-editor-container" 
                        [class.invalid]="hasFieldError('fix_issue_description')"
                        [class.disabled]="!isFormReady() || supporterFormState.isSaving || !isSupporter || !isResolvedActionSelected">
                        
                        <div class="editor-toolbar">
                            <div class="toolbar-section">
                                <select class="font-select width-172" [disabled]="!isFormReady() || !isSupporter || !isResolvedActionSelected">
                                    <option>Noto Sans Thai</option>
                                    <option>Arial</option>
                                    <option>Times New Roman</option>
                                </select>
                                <select class="size-select width-171" [disabled]="!isFormReady() || !isSupporter || !isResolvedActionSelected">
                                    <option>14</option>
                                    <option>12</option>
                                    <option>16</option>
                                    <option>18</option>
                                </select>
                            </div>

                            <div class="toolbar-separator"></div>
                            
                            <div class="toolbar-section">
                                <button type="button" class="toolbar-btn" (click)="richImgInput.click()" title="Upload Image"
                                    [disabled]="!isFormReady() || !isSupporter || !isResolvedActionSelected">
                                    <i class="bi bi-image"></i>
                                </button>
                                <input type="file" #richImgInput style="display: none" (change)="onRichTextConfigImage($event)" accept="image/*">
                            </div>

                            <div class="toolbar-section">
                                <button type="button" class="toolbar-btn" [class.active]="toolbarState.bold" (click)="formatText('bold')" title="Bold"
                                    [disabled]="!isFormReady() || !isSupporter || !isResolvedActionSelected">
                                    <i class="bi bi-type-bold"></i>
                                </button>
                            </div>

                        </div>
                        
                        <div class="rich-editor" 
                            #fixIssueEditor
                            [class.invalid]="hasFieldError('fix_issue_description')"
                            contenteditable="true" 
                            (input)="onDescriptionInput($event)"
                            (click)="onEditorEvent()"
                            (keyup)="onEditorEvent()"
                            (mouseup)="onEditorEvent()"
                            [attr.placeholder]="translate('supportInformation.resolutionPlaceholder')"
                            [attr.disabled]="!isFormReady() || supporterFormState.isSaving || !isSupporter || !isResolvedActionSelected ? true : null">
                        </div>
                        <div class="editor-footer p-2 bg-light d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                {{ translate('supportInformation.resolutionHint') }}
                            </small>
                            <small class="text-muted">
                                {{ supporterForm.get('fix_issue_description')?.value?.length || 0 }}/5000 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£
                            </small>
                        </div>

                        <div *ngIf="hasFieldError('fix_issue_description')" class="invalid-feedback">
                            {{ getFieldError('fix_issue_description') }}
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-group">
                    <label class="required">{{ translate('supportInformation.attachment') }}</label>

                    <div class="attachment-container" [class.dragover]="isDraggingFiles"
                        [class.disabled-upload]="!isSupporter || !isResolvedActionSelected" 
                        (dragover)="onAttachmentsDragOver($event)"
                        (dragleave)="onAttachmentsDragLeave($event)" (drop)="onAttachmentsDrop($event)">

                        <div class="attachment-upload-card"
                            (click)="isFormReady() && isSupporter && isResolvedActionSelected && selectedFiles.length < maxFiles && fileInputNew.click()"
                            [class.disabled]="!isFormReady() || supporterFormState.isSaving || (existingFixAttachments.length + selectedFiles.length) >= maxFiles || !isSupporter || !isResolvedActionSelected"
                            [title]="translate('supportInformation.dragDropHint')">
                            <i class="bi bi-plus-lg upload-icon"></i>
                            <span class="upload-label">{{ translate('tickets.chooseFile') }}</span>
                            <small class="text-muted" *ngIf="maxFiles">
                                ({{ existingFixAttachments.length + selectedFiles.length }}/{{ maxFiles }})
                            </small>
                        </div>

                        <ng-container>
                            <app-file-list [attachments]="existingFixAttachments" 
                                [title]="translate('supportInformation.attachment')"
                                [showTitle]="false" (fileClick)="onAttachmentClick($event)"
                                (fileDelete)="onExistingAttachmentDelete($event)">
                            </app-file-list>

                            <div *ngFor="let file of selectedFiles; let i = index; trackBy: trackByFile"
                                class="attachment-card new">
                                <button type="button" class="remove-attachment-btn" (click)="removeSelectedFile(i)"
                                    title="‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ" [disabled]="!isSupporter || !isResolvedActionSelected">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <div class="attachment-preview">
                                    <img *ngIf="ticketService.isImageFile(file)" [src]="getFilePreview(file)"
                                        alt="Preview" class="attachment-img" />
                                    <div *ngIf="!ticketService.isImageFile(file)" class="attachment-icon-wrapper">
                                        <i [class]="ticketService.getFileIcon(file.name)" class="attachment-icon"></i>
                                        <span class="file-type-label">
                                            {{ getFileTypeFromExtension(file.name).toUpperCase() }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </ng-container>

                        <input #fileInputNew type="file" id="fileInputNew" (change)="onFileSelected($event)" multiple
                            accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.txt,.xlsx,.csv" style="display: none;"
                            [disabled]="isFileLimitReached() || !isSupporter || !isResolvedActionSelected" />
                    </div>

                    <small class="form-text text-muted mt-2 d-block">
                        {{ translate('supportInformation.fileTypeHint') }} ‚Äî
                        {{ translate('tickets.fileUploadInstructions') }}
                    </small>
                </div>
            </div>


            <div class="form-actions">
                <button type="button" class="save-btn" (click)="onSaveAll()" [disabled]="!canSaveAll()"
                    [class]="getSaveAllButtonClass()" [title]="getSaveAllButtonTooltip()">

                    <span *ngIf="supporterFormState.isSaving">
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        {{ translate('supportInformation.saving') }}
                    </span>

                    <span *ngIf="!supporterFormState.isSaving">
                        <i class="bi me-2" [class.bi-floppy]="!selectedAssigneeId"
                            [class.bi-floppy2]="selectedAssigneeId && hasSupporterFormChanges()"
                            [class.bi-person-plus]="selectedAssigneeId && !hasSupporterFormChanges()">
                        </i>
                        {{ getSaveAllButtonText() }}
                    </span>
                </button>

                <button type="button" class="btn btn-outline-info ms-2" (click)="persistAllFormData()"
                    [disabled]="!isFormReady() || !hasFormData()" *ngIf="false"
                    [title]="translate('supportInformation.forceSave')">
                    <i class="bi bi-cloud-arrow-up me-2"></i>
                    {{ translate('supportInformation.forceSave') }}
                </button>

                <div class="form-status-info ms-auto d-flex align-items-center" *ngIf="!supporterFormState.isSaving">
                    <small class="text-success d-flex align-items-center me-3"
                        *ngIf="hasFormData() && getPersistedDataInfo()">
                        <i class="bi bi-cloud-check me-1"></i>
                        <span>{{ translate('supportInformation.autoSaved') }}</span>
                    </small>

                    <small class="text-muted d-flex align-items-center me-3">
                        <i class="bi me-1" [class.bi-circle-fill]="!hasFormData()"
                            [class.bi-circle-half]="hasFormData() && !canSaveAll()"
                            [class.bi-check-circle]="canSaveAll()" [class.text-secondary]="!hasFormData()"
                            [class.text-warning]="hasFormData() && !canSaveAll()" [class.text-success]="canSaveAll()">
                        </i>
                        <span *ngIf="!hasFormData()">{{ translate('supportInformation.formEmpty') }}</span>
                        <span *ngIf="hasFormData() && !canSaveAll()">{{ translate('supportInformation.hasData') }}</span>
                        <span *ngIf="canSaveAll()">{{ translate('supportInformation.readyToSave') }}</span>
                    </small>
                </div>
            </div>
        </form>
    </div>

    <div class="text-center py-5" *ngIf="!canShowSupporterForm() && !isLoadingTicketData">
        <i class="bi bi-shield-exclamation text-muted" style="font-size: 4rem;"></i>
        <h5 class="text-muted mt-3">{{ translate('supportInformation.noPermission') }}</h5>
        <p class="text-muted">{{ translate('supportInformation.noPermissionMsg') }}</p>
        <small class="text-muted">
            {{ translate('supportInformation.requiredPermission') }}
        </small>
    </div>

    <app-file-preview-modal [attachment]="selectedAttachment" [show]="showFileModal" (close)="closeModal()">
    </app-file-preview-modal>

</div>